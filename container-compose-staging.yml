services:
  nginx:
    build:
      context: extenginx
      additional_contexts:
        - NGINX_SNIPPET_SOURCE=./nginx_snippets
      dockerfile: Containerfile
      target: nginx
      args:
        NGINX_HOSTNAME: dev.underground.software
    volumes:
      - type: bind
        source: ./ssl
        target: /etc/ssl/nginx
        read_only: true
        selinux: z
      - type: bind
        source: ./kdlp.underground.software
        target: /var/www/html
        read_only: true
        selinux: z
    ports:
      - target: 80
        published: 80
        protocol: tcp
        app_protocol: http
        mode: host
        name: "port for http connections to proxy"
      - target: 443
        published: 443
        protocol: tcp
        app_protocol: https
        mode: host
        name: "port for https connections to proxy"
      - target: 465
        published: 465
        protocol: tcp
        app_protocol: smtps
        mode: host
        name: "port for smtps connections to proxy"
      - target: 995
        published: 995
        protocol: tcp
        app_protocol: pop3s
        mode: host
        name: "port for pop3s connections to proxy"
  orbit:
    build:
      context: orbit
      dockerfile: Containerfile
      target: orbit
      args:
        - PRODUCTION: false
    volumes:
      - type: bind
        source: ./.git
        target: /var/git/singularity
        read_only: true
        selinux: z
      - type: bind
        source: ./kdlp.underground.software
        target: /orbit/docs
        read_only: true
        selinux: z
    ports:
      - target: 9098
        published: 9098
        protocol: tcp
        app_protocol: http
        mode: host
        name: "unencrypted http upstream server port"
  smtp:
    build:
      context: smtp
      dockerfile: Containerfile
      additional_contexts:
        - TCP_SERVER_SOURCE=./tcp_server
      target: smtp
      args:
        hostname: dev.underground.software
    volumes:
      - type: bind
        source: ./email
        target: /mnt/email_data
        read_only: false
        selinux: z
    ports:
      - target: 465
        published: 11465
        protocol: tcp
        app_protocol: smtp
        mode: host
        name: "unencrypted smtp upstream server port"
  pop:
    build:
      context: pop
      dockerfile: Containerfile
      additional_contexts:
        - TCP_SERVER_SOURCE=./tcp_server
      target: pop
    volumes:
      - type: bind
        source: ./email/mail
        target: /mnt/mail
        read_only: true
        selinux: z
    ports:
      - target: 995
        published: 11995
        protocol: tcp
        app_protocol: pop3
        mode: host
        name: "unencrypted pop3 upstream server port"
